var me=Object.defineProperty;var oe=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var ne=(n,e,t)=>e in n?me(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,N=(n,e)=>{for(var t in e||(e={}))ue.call(e,t)&&ne(n,t,e[t]);if(oe)for(var t of oe(e))ve.call(e,t)&&ne(n,t,e[t]);return n};var d=(n,e,t)=>new Promise((s,i)=>{var a=h=>{try{u(t.next(h))}catch(p){i(p)}},l=h=>{try{u(t.throw(h))}catch(p){i(p)}},u=h=>h.done?s(h.value):Promise.resolve(h.value).then(a,l);u((t=t.apply(n,e)).next())});import{ClientRequest as Te}from"http";import b from"picocolors";import{URL as we}from"url";import ye from"clean-css";var P=class{constructor(e,t,s,i){this.options=e;this.logger=t;this.downloader=s;this.fileCache=i;this.fontUrlRegex=/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi}loadAll(e,t){return d(this,null,function*(){let s="";for(let i of e){let a=yield this.load(i),l=this.normalizeUrls(a.trim(),i);s+=l+`
`}return this.formatCss(s,t)})}formatCss(e,t){return!t&&this.options.minifyCss?this.minify(e):e.trim()}minify(e){return new ye().minify(e).styles}normalizeUrls(e,t){return e=e.replaceAll(this.fontUrlRegex,s=>s.startsWith("http://")||s.startsWith("https://")?s:s.startsWith("//")?"https:"+s:new we(s,t).href),e}load(e){return d(this,null,function*(){this.logger.flashLine(e);let t=this.fileCache.get("css",e);if(t)return t;let s=yield this.downloader.download(e,"text");return this.fileCache.save("css",e,s.data),s.data})}};var D=class{constructor(){this.fontSrcRegex=/(?:https?:)?\/\/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi;this.googleFontsKitSrcRegex=/https:\/\/fonts\.gstatic\.com\/l\/font\?kit=[a-z0-9&=_-]+/gi;this.fontFilenameRegex=/[^/]+\.(?:woff2?|eot|ttf|otf|svg)/i;this.googleFontsFileRegex=/\?kit=([a-z0-9_-]+)/i;this.webfontProviders=[/https:\/\/fonts\.googleapis\.com\//i,/https:\/\/fonts\.gstatic\.com\//i,/https:\/\/fonts\.bunny\.net\//i,/https:\/\/api\.fontshare\.com\//i]}parse(e,t,s){var u,h;let i=new Map,a=e.matchAll(this.fontSrcRegex),l=e.matchAll(this.googleFontsKitSrcRegex);if(a)for(let p of a){let x=p.toString(),g=x.match(this.fontFilenameRegex);if(g){let v=g[0];i.set(v,{url:x,filename:v,localPath:t+(s?s+"/":"")+v})}}if(l)for(let p of l){let x=p.toString(),g=(h=(u=x.match(this.googleFontsFileRegex))==null?void 0:u[1])==null?void 0:h.toString();g&&i.set(g+".woff2",{url:x,filename:g,localPath:t+(s?s+"/":"")+g+".woff2"})}return i}parseBundleCss(e,t,s){let i=new Map,a=new Set([]),l=[],u=/@import\s*(?:url\()?['"]?([^\s'"]+)['"]?\)?;/g,h=/@font-face\s*{[^}]*}/g,p=[...e.matchAll(u)];return[...e.matchAll(h)].forEach(g=>{let v=g[0];this.parse(v,t,s).forEach(T=>{this.webfontProviders.some(E=>E.test(T.url))&&(i.set(T.filename,T),l.push(g[0]))})}),p.forEach(g=>{let v=g[1];this.webfontProviders.some(S=>S.test(v))&&(a.add(v),l.push(g[0]))}),{fonts:i,webfontUrlsCss:a,matchedCssParts:l}}};var j=class{constructor(e){this.options=e}injectAsStylesheet(e,t,s){return this.options.async?this.injectAsync(e,t,s):this.injectSync(e,t,s)}injectAsStyleTag(e,t){return this.options.minifyCss?e.replace(/(\n?)([ \t]*)<\/head>/,`$1$2$2<style>${t}</style>$1$2</head>`):e.replace(/([ \t]*)<\/head>/,`$1$1<style>
${t.replace(/^/gm,"$1$1$1")}
$1$1</style>
$1</head>`)}injectAsync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" media="print" onload="this.onload=null;this.removeAttribute('media');" href="${t}${s}">
$1</head>`)}injectSync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" href="${t}${s}">
$1</head>`)}};var ie=(l=>(l.woff2="font/woff2",l.woff="font/woff",l.ttf="font/ttf",l.otf="font/otf",l.svg="image/svg+xml",l.eot="application/vnd.ms-fontobject",l))(ie||{}),W=class{constructor(e){this.options=e}transform(e,t){return t.forEach(s=>{if(!this.options.embedFonts||!s.binary)e=e.replaceAll(s.url,s.localPath);else if(s.binary){let i=new RegExp(`url\\(['"]?\\b${s.url}\\b['"]?\\)`,"gi");e=e.replaceAll(i,`url(data:${this.getFontMime(s)};base64,${s.binary.toString("base64")})`)}}),e}getFontMime(e){let t=e.filename.replace(/^.+\.(.+)$/,"$1");return ie[t]}};import{Axios as be,isAxiosError as xe}from"axios";import{Agent as Ce}from"http";import{Agent as Fe}from"https";import z from"picocolors";var M=class{constructor(e,t){this.options=e;this.logger=t;this.userAgentWoff2="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.0.0 Safari/537.36";this.maxTries=3;this.timeout=2500;this.waitBeforeRetry=[25,2500];this.axios=new be({timeout:this.timeout,proxy:this.options.proxy,httpAgent:new Ce({keepAlive:!0,family:4}),httpsAgent:new Fe({keepAlive:!0,family:4})})}download(e,t,s=1){return d(this,null,function*(){try{let i=yield this.toRequest(e,t);return s>1&&this.logger.info(z.green(`\u2713 ${e}`)+" "+z.dim(`(try #${s})`)),i}catch(i){if(this.logger.error(z.red(`\u2717 ${e}`)+" "+z.dim(`(try #${s})`)+": "+(xe(i)?i.message:i)),s<this.maxTries)return yield new Promise(a=>setTimeout(a,this.randomWaitInterval())),this.download(e,t,s+1);throw i}})}toRequest(e,t){return this.axios.get(e,{headers:{"User-Agent":this.userAgentWoff2,"Accept-Encoding":"gzip"},responseType:t!=null?t:"arraybuffer"})}randomWaitInterval(){return Math.floor(Math.random()*(this.waitBeforeRetry[0]-this.waitBeforeRetry[1]+1)+this.waitBeforeRetry[1])}};var H=class{constructor(e,t,s){this.logger=e;this.downloader=t;this.fileCache=s}load(e){return d(this,null,function*(){let t=this.fileCache.get("font",e);if(t)return t;this.logger.flashLine(e);let s=yield this.downloader.download(e);return this.fileCache.save("font",e,s.data),s.data})}};import I from"flat-cache";var B="3.9.1";var U=class{constructor(e){this.enabled=!0;this.hits={css:0,font:0};e.cache===!1&&(this.enabled=!1),this.storeCss=I.create(`vite-plugin-webfont-dl__${B}__css`),this.storeFont=I.create(`vite-plugin-webfont-dl__${B}__font`),this.enabled||this.clear()}get(e,t){if(!this.enabled)return;let s=e==="css"?this.storeCss.getKey(t):this.storeFont.getKey(t);if(s)return e==="css"?this.hits.css++:this.hits.font++,s.type!==void 0?Buffer.from(s.data):s}save(e,t,s){this.enabled&&(e==="css"?(this.storeCss.setKey(t,s),this.storeCss.save(!0)):(this.storeFont.setKey(t,s),this.storeFont.save(!0)))}clear(){I.clearCacheById(`vite-plugin-webfont-dl__${B}__css`),I.clearCacheById(`vite-plugin-webfont-dl__${B}__font`)}};var K=class{constructor(){this.webfontRegexes=[new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/fonts\\.googleapis\\.com[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/fonts\\.googleapis\\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/fonts\\.bunny\\.net[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/fonts\\.bunny\\.net[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/api\\.fontshare\\.com[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/api\\.fontshare\\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/cdn\\.jsdelivr\\.net[^'">]+\\.css)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/cdn\\.jsdelivr\\.net[^'">]+\\.css)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/rsms\\.me[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/rsms\\.me[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs")];this.preconnectRegexes=[/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/rsms\.me['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/rsms\.me['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/]}parse(e){let t=new Set;for(let s of this.webfontRegexes){let i=e.matchAll(s);if(i)for(let a of i)(!a[1]||a[1].includes("-->"))&&t.add(a[2])}return t}removeTags(e){return e=this.removePreconnectTags(e),e=this.removeWebfontTags(e),e}removePreconnectTags(e){for(let t of this.preconnectRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}removeWebfontTags(e){for(let t of this.webfontRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}};import{env as Ae,stdout as $}from"process";import Re from"picocolors";var _=class{setResolvedLogger(e){this.resolvedLogger=e}isTty(){return $.isTTY&&!Ae.CI}info(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.info((t?this.prefix():"")+e)}error(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.error((t?this.prefix():"")+e)}clearLine(){this.isTty()&&($.clearLine(0),$.cursorTo(0))}flashLine(e,t=!0){this.isTty()?(this.clearLine(),e=(t?this.prefix():"")+e,e.length<$.columns?$.write(e):$.write(e.substring(0,$.columns-1)),this.flashTimeout&&clearTimeout(this.flashTimeout),this.flashTimeout=setTimeout(()=>{this.clearLine()},500)):this.info(e,t)}prefix(){return Re.dim("[webfont-dl] ")}};var Se={injectAsStyleTag:!0,minifyCss:!0,embedFonts:!1,async:!0,cache:!0,proxy:!1},ae=(n={})=>N(N({},Se),n);import{AxiosError as Le}from"axios";function yt(n,e){!Array.isArray(n)&&typeof n!="string"&&(n=[]),typeof n=="string"&&n!==""&&(n=[n]);let t=new Set(n||[]),s=new Set([]),i=new Set([]),a=ae(e),l=new Map,u="webfonts.css",h=new Map,p=new _,x=new M(a,p),g=new U(a),v=new P(a,p,x,g),S=new D,T=new W(a),E=new j(a),X=new H(p,x,g),q=new K,C,V,L,F,A,w="",O,k=new Map,G=r=>{for(let o of q.parse(r))s.add(o)},le=()=>{s.clear(),k.forEach(r=>{G(r)})},ce=r=>{i.clear();for(let o in r)if(o.match(/\.css$/)){let c=r[o].source.toString(),y=S.parseBundleCss(c,F,A);y.matchedCssParts.length&&(y.fonts.forEach(f=>{l.set(f.filename,f)}),y.webfontUrlsCss.forEach(f=>{i.add(f)}),y.matchedCssParts.forEach(f=>{c=c.replaceAll(f,""),w+=f+`
`}),r[o].source=c,w=v.formatCss(w,!!C))}},Y=()=>d(this,null,function*(){w="";let r=Date.now(),o=new Set([...t,...s,...i]);return o.size&&(w+=yield v.loadAll(o,!!C)),C||p.info(b.green("\u2713")+" "+o.size.toString()+" webfont css downloaded. "+b.dim("("+b.bold(te(r))+", "+(a.cache!==!1?`cache hit: ${b.bold(se(g.hits.css,o.size))}`:"cache disabled")+")"),!1),w}),J=r=>{S.parse(r,F,A).forEach(c=>{l.set(c.filename,c)})},Q=()=>{w=T.transform(w,l)},fe=()=>d(this,null,function*(){let r=Date.now();for(let[,o]of l){let c=yield X.load(o.url);ge(o,c)}p.info(b.green("\u2713")+" "+l.size+" webfonts downloaded. "+b.dim("("+b.bold(te(r))+", "+(a.cache!==!1?`cache hit: ${b.bold(se(g.hits.font,l.size))}`:"cache disabled")+")"),!1)}),pe=r=>d(this,null,function*(){let o=X.load(r);return p.clearLine(),o}),ge=(r,o)=>{a.embedFonts?r.binary=o:r.localPath=F+Z(r.filename,o)},he=()=>d(this,null,function*(){J(yield Y()),Q(),h.clear(),l.forEach(r=>{h.set(r.localPath,r.url)})}),de=()=>{O=Z(u,w)},Z=(r,o)=>{let c=V.emitFile({name:r,type:"asset",source:o});return V.getFileName(c)},ee=(r,o)=>C||a.injectAsStyleTag===!1?E.injectAsStylesheet(r,F,O):E.injectAsStyleTag(r,o),te=r=>(Date.now()-r).toLocaleString()+" ms",se=(r,o)=>(Math.round(r/o*100*100)/100).toFixed(2)+"%";return{name:"vite-plugin-webfont-dl",enforce:"post",configResolved(r){L=r,F=L.base,A=L.build.assetsDir,O=A+"/"+u,L.build.minify===!1&&(e==null?void 0:e.minifyCss)!==!0&&(a.minifyCss=!1),p.setResolvedLogger(L.logger)},configureServer(r){C=r,A="@webfonts",O=A+"/"+u;let o=(y,f)=>{d(this,null,function*(){f.setHeader("Content-Type","text/css");try{yield he(),f.end(w)}catch(m){p.error(b.red(m.message)),f.statusCode=502,f.setHeader("X-Error",m.message.replace(/^Error: /,"")),f.end()}})},c=(y,f)=>{d(this,null,function*(){var R;let m=(R=y.originalUrl)==null?void 0:R.replace(/[?#].*$/,"");f.setHeader("Access-Control-Allow-Origin","*"),f.end(yield pe(h.get(m)))})};C.middlewares.use(F+O,o),C.middlewares.use(F+u,o),C.middlewares.use((y,f,m)=>{var re;let R=(re=y.originalUrl)==null?void 0:re.replace(/[?#].*$/,"");if(!R)return m();R.match(/\.(?:woff2?|eot|ttf|otf|svg)$/)&&h.has(R)?c(y,f):m()})},transformIndexHtml(r,o){return k.set(o.path.replace(/^\//,""),r),C&&(s.clear(),G(r),r=q.removeTags(r),r=ee(r)),r},generateBundle(r,o){return d(this,null,function*(){V=this,le(),ce(o);try{let c=yield Y();c&&(J(c),yield fe(),Q(),(a.injectAsStyleTag===!1||!k.size)&&de(),k.forEach((y,f)=>{let m=o[f];m!==void 0&&(m.source=q.removeTags(m.source),m.source=ee(m.source,w),k.set(f,m.source))}))}catch(c){p.error(b.red(c.message)),c instanceof Le&&c.request instanceof Te&&p.error(b.red(`${c.request.method} ${c.request.protocol}//${c.request.host}${c.request.path}`))}})}}}export{yt as ViteWebfontDownload,yt as default,yt as viteWebfontDl,yt as viteWebfontDownload,yt as webfontDl,yt as webfontDownload};
