"use strict";var Se=Object.create;var B=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames,ae=Object.getOwnPropertySymbols,Oe=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var le=(r,e,t)=>e in r?B(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Y=(r,e)=>{for(var t in e||(e={}))ce.call(e,t)&&le(r,t,e[t]);if(ae)for(var t of ae(e))ke.call(e,t)&&le(r,t,e[t]);return r};var Be=(r,e)=>{for(var t in e)B(r,t,{get:e[t],enumerable:!0})},fe=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Le(e))!ce.call(r,n)&&n!==t&&B(r,n,{get:()=>e[n],enumerable:!(s=Te(e,n))||s.enumerable});return r};var E=(r,e,t)=>(t=r!=null?Se(Oe(r)):{},fe(e||!r||!r.__esModule?B(t,"default",{value:r,enumerable:!0}):t,r)),Ee=r=>fe(B({},"__esModule",{value:!0}),r);var d=(r,e,t)=>new Promise((s,n)=>{var a=h=>{try{u(t.next(h))}catch(p){n(p)}},l=h=>{try{u(t.throw(h))}catch(p){n(p)}},u=h=>h.done?s(h.value):Promise.resolve(h.value).then(a,l);u((t=t.apply(r,e)).next())});var We={};Be(We,{ViteWebfontDownload:()=>je,default:()=>je,viteWebfontDl:()=>je,viteWebfontDownload:()=>je,webfontDl:()=>je,webfontDownload:()=>je});module.exports=Ee(We);var we=require("http"),v=E(require("picocolors"));var pe=require("url"),ge=E(require("clean-css"));var z=class{constructor(e,t,s,n){this.options=e;this.logger=t;this.downloader=s;this.fileCache=n;this.fontUrlRegex=/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi}loadAll(e,t){return d(this,null,function*(){let s="";for(let n of e){let a=yield this.load(n),l=this.normalizeUrls(a.trim(),n);s+=l+`
`}return this.formatCss(s,t)})}formatCss(e,t){return!t&&this.options.minifyCss?this.minify(e):e.trim()}minify(e){return new ge.default().minify(e).styles}normalizeUrls(e,t){return e=e.replaceAll(this.fontUrlRegex,s=>s.startsWith("http://")||s.startsWith("https://")?s:s.startsWith("//")?"https:"+s:new pe.URL(s,t).href),e}load(e){return d(this,null,function*(){this.logger.flashLine(e);let t=this.fileCache.get("css",e);if(t)return t;let s=yield this.downloader.download(e,"text");return this.fileCache.save("css",e,s.data),s.data})}};var M=class{constructor(){this.fontSrcRegex=/(?:https?:)?\/\/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi;this.googleFontsKitSrcRegex=/https:\/\/fonts\.gstatic\.com\/l\/font\?kit=[a-z0-9&=_-]+/gi;this.fontFilenameRegex=/[^/]+\.(?:woff2?|eot|ttf|otf|svg)/i;this.googleFontsFileRegex=/\?kit=([a-z0-9_-]+)/i;this.webfontProviders=[/https:\/\/fonts\.googleapis\.com\//i,/https:\/\/fonts\.gstatic\.com\//i,/https:\/\/fonts\.bunny\.net\//i,/https:\/\/api\.fontshare\.com\//i]}parse(e,t,s){var u,h;let n=new Map,a=e.matchAll(this.fontSrcRegex),l=e.matchAll(this.googleFontsKitSrcRegex);if(a)for(let p of a){let C=p.toString(),g=C.match(this.fontFilenameRegex);if(g){let w=g[0];n.set(w,{url:C,filename:w,localPath:t+(s?s+"/":"")+w})}}if(l)for(let p of l){let C=p.toString(),g=(h=(u=C.match(this.googleFontsFileRegex))==null?void 0:u[1])==null?void 0:h.toString();g&&n.set(g+".woff2",{url:C,filename:g,localPath:t+(s?s+"/":"")+g+".woff2"})}return n}parseBundleCss(e,t,s){let n=new Map,a=new Set([]),l=[],u=/@import\s*(?:url\()?['"]?([^\s'"]+)['"]?\)?;/g,h=/@font-face\s*{[^}]*}/g,p=[...e.matchAll(u)];return[...e.matchAll(h)].forEach(g=>{let w=g[0];this.parse(w,t,s).forEach(T=>{this.webfontProviders.some(W=>W.test(T.url))&&(n.set(T.filename,T),l.push(g[0]))})}),p.forEach(g=>{let w=g[1];this.webfontProviders.some(S=>S.test(w))&&(a.add(w),l.push(g[0]))}),{fonts:n,webfontUrlsCss:a,matchedCssParts:l}}};var H=class{constructor(e){this.options=e}injectAsStylesheet(e,t,s){return this.options.async?this.injectAsync(e,t,s):this.injectSync(e,t,s)}injectAsStyleTag(e,t){return this.options.minifyCss?e.replace(/(\n?)([ \t]*)<\/head>/,`$1$2$2<style>${t}</style>$1$2</head>`):e.replace(/([ \t]*)<\/head>/,`$1$1<style>
${t.replace(/^/gm,"$1$1$1")}
$1$1</style>
$1</head>`)}injectAsync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" media="print" onload="this.onload=null;this.removeAttribute('media');" href="${t}${s}">
$1</head>`)}injectSync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" href="${t}${s}">
$1</head>`)}};var he=(l=>(l.woff2="font/woff2",l.woff="font/woff",l.ttf="font/ttf",l.otf="font/otf",l.svg="image/svg+xml",l.eot="application/vnd.ms-fontobject",l))(he||{}),I=class{constructor(e){this.options=e}transform(e,t){return t.forEach(s=>{if(!this.options.embedFonts||!s.binary)e=e.replaceAll(s.url,s.localPath);else if(s.binary){let n=new RegExp(`url\\(['"]?\\b${s.url}\\b['"]?\\)`,"gi");e=e.replaceAll(n,`url(data:${this.getFontMime(s)};base64,${s.binary.toString("base64")})`)}}),e}getFontMime(e){let t=e.filename.replace(/^.+\.(.+)$/,"$1");return he[t]}};var K=require("axios"),de=require("http"),me=require("https"),P=E(require("picocolors"));var U=class{constructor(e,t){this.options=e;this.logger=t;this.userAgentWoff2="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.0.0 Safari/537.36";this.maxTries=3;this.timeout=2500;this.waitBeforeRetry=[25,2500];this.axios=new K.Axios({timeout:this.timeout,proxy:this.options.proxy,httpAgent:new de.Agent({keepAlive:!0,family:4}),httpsAgent:new me.Agent({keepAlive:!0,family:4})}),this.axios.defaults.headers.common["Accept-Encoding"]="gzip"}download(e,t,s=1){return d(this,null,function*(){try{let n=yield this.toRequest(e,t);return s>1&&this.logger.info(P.default.green(`\u2713 ${e}`)+" "+P.default.dim(`(try #${s})`)),n}catch(n){if(this.logger.error(P.default.red(`\u2717 ${e}`)+" "+P.default.dim(`(try #${s})`)+": "+((0,K.isAxiosError)(n)?n.message:n)),s<this.maxTries)return yield new Promise(a=>setTimeout(a,this.randomWaitInterval())),this.download(e,t,s+1);throw n}})}toRequest(e,t){return this.axios.get(e,{headers:{"User-Agent":this.userAgentWoff2},responseType:t!=null?t:"arraybuffer"})}randomWaitInterval(){return Math.floor(Math.random()*(this.waitBeforeRetry[0]-this.waitBeforeRetry[1]+1)+this.waitBeforeRetry[1])}};var _=class{constructor(e,t,s){this.logger=e;this.downloader=t;this.fileCache=s}load(e){return d(this,null,function*(){let t=this.fileCache.get("font",e);if(t)return t;this.logger.flashLine(e);let s=yield this.downloader.download(e);return this.fileCache.save("font",e,s.data),s.data})}};var j=E(require("flat-cache"));var D="3.9.1";var q=class{constructor(e){this.enabled=!0;this.hits={css:0,font:0};e.cache===!1&&(this.enabled=!1),this.storeCss=j.default.create(`vite-plugin-webfont-dl__${D}__css`),this.storeFont=j.default.create(`vite-plugin-webfont-dl__${D}__font`),this.enabled||this.clear()}get(e,t){if(!this.enabled)return;let s=e==="css"?this.storeCss.getKey(t):this.storeFont.getKey(t);if(s)return e==="css"?this.hits.css++:this.hits.font++,s.type!==void 0?Buffer.from(s.data):s}save(e,t,s){this.enabled&&(e==="css"?(this.storeCss.setKey(t,s),this.storeCss.save(!0)):(this.storeFont.setKey(t,s),this.storeFont.save(!0)))}clear(){j.default.clearCacheById(`vite-plugin-webfont-dl__${D}__css`),j.default.clearCacheById(`vite-plugin-webfont-dl__${D}__font`)}};var V=class{constructor(){this.webfontRegexes=[new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/fonts\\.googleapis\\.com[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/fonts\\.googleapis\\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/fonts\\.bunny\\.net[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/fonts\\.bunny\\.net[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/api\\.fontshare\\.com[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/api\\.fontshare\\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/cdn\\.jsdelivr\\.net[^'">]+\\.css)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/cdn\\.jsdelivr\\.net[^'">]+\\.css)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\\/\\/rsms\\.me[^'">]+)['"]?[^>]*>`,"gs"),new RegExp(`(<!--.*?)?<link[^>]+href=['"]?(https:\\/\\/rsms\\.me[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>`,"gs")];this.preconnectRegexes=[/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/rsms\.me['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/rsms\.me['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/]}parse(e){let t=new Set;for(let s of this.webfontRegexes){let n=e.matchAll(s);if(n)for(let a of n)(!a[1]||a[1].includes("-->"))&&t.add(a[2])}return t}removeTags(e){return e=this.removePreconnectTags(e),e=this.removeWebfontTags(e),e}removePreconnectTags(e){for(let t of this.preconnectRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}removeWebfontTags(e){for(let t of this.webfontRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}};var x=require("process"),ue=E(require("picocolors")),N=class{setResolvedLogger(e){this.resolvedLogger=e}isTty(){return x.stdout.isTTY&&!x.env.CI}info(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.info((t?this.prefix():"")+e)}error(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.error((t?this.prefix():"")+e)}clearLine(){this.isTty()&&(x.stdout.clearLine(0),x.stdout.cursorTo(0))}flashLine(e,t=!0){this.isTty()?(this.clearLine(),e=(t?this.prefix():"")+e,e.length<x.stdout.columns?x.stdout.write(e):x.stdout.write(e.substring(0,x.stdout.columns-1)),this.flashTimeout&&clearTimeout(this.flashTimeout),this.flashTimeout=setTimeout(()=>{this.clearLine()},500)):this.info(e,t)}prefix(){return ue.default.dim("[webfont-dl] ")}};var De={injectAsStyleTag:!0,minifyCss:!0,embedFonts:!1,async:!0,cache:!0,proxy:!1},ve=(r={})=>Y(Y({},De),r);var ye=require("axios");function je(r,e){!Array.isArray(r)&&typeof r!="string"&&(r=[]),typeof r=="string"&&r!==""&&(r=[r]);let t=new Set(r||[]),s=new Set([]),n=new Set([]),a=ve(e),l=new Map,u="webfonts.css",h=new Map,p=new N,C=new U(a,p),g=new q(a),w=new z(a,p,C,g),S=new M,T=new I(a),W=new H(a),J=new _(p,C,g),X=new V,F,G,L,$,A,y="",O,k=new Map,Q=o=>{for(let i of X.parse(o))s.add(i)},be=()=>{s.clear(),k.forEach(o=>{Q(o)})},xe=o=>{n.clear();for(let i in o)if(i.match(/\.css$/)){let c=o[i].source.toString(),b=S.parseBundleCss(c,$,A);b.matchedCssParts.length&&(b.fonts.forEach(f=>{l.set(f.filename,f)}),b.webfontUrlsCss.forEach(f=>{n.add(f)}),b.matchedCssParts.forEach(f=>{c=c.replaceAll(f,""),y+=f+`
`}),o[i].source=c,y=w.formatCss(y,!!F))}},Z=()=>d(this,null,function*(){y="";let o=Date.now(),i=new Set([...t,...s,...n]);return i.size&&(y+=yield w.loadAll(i,!!F)),F||p.info(v.default.green("\u2713")+" "+i.size.toString()+" webfont css downloaded. "+v.default.dim("("+v.default.bold(oe(o))+", "+(a.cache!==!1?`cache hit: ${v.default.bold(ne(g.hits.css,i.size))}`:"cache disabled")+")"),!1),y}),ee=o=>{S.parse(o,$,A).forEach(c=>{l.set(c.filename,c)})},te=()=>{y=T.transform(y,l)},Ce=()=>d(this,null,function*(){let o=Date.now();for(let[,i]of l){let c=yield J.load(i.url);$e(i,c)}p.info(v.default.green("\u2713")+" "+l.size+" webfonts downloaded. "+v.default.dim("("+v.default.bold(oe(o))+", "+(a.cache!==!1?`cache hit: ${v.default.bold(ne(g.hits.font,l.size))}`:"cache disabled")+")"),!1)}),Fe=o=>d(this,null,function*(){let i=J.load(o);return p.clearLine(),i}),$e=(o,i)=>{a.embedFonts?o.binary=i:o.localPath=$+se(o.filename,i)},Ae=()=>d(this,null,function*(){ee(yield Z()),te(),h.clear(),l.forEach(o=>{h.set(o.localPath,o.url)})}),Re=()=>{O=se(u,y)},se=(o,i)=>{let c=G.emitFile({name:o,type:"asset",source:i});return G.getFileName(c)},re=(o,i)=>F||a.injectAsStyleTag===!1?W.injectAsStylesheet(o,$,O):W.injectAsStyleTag(o,i),oe=o=>(Date.now()-o).toLocaleString()+" ms",ne=(o,i)=>(Math.round(o/i*100*100)/100).toFixed(2)+"%";return{name:"vite-plugin-webfont-dl",enforce:"post",configResolved(o){L=o,$=L.base,A=L.build.assetsDir,O=A+"/"+u,L.build.minify===!1&&(e==null?void 0:e.minifyCss)!==!0&&(a.minifyCss=!1),p.setResolvedLogger(L.logger)},configureServer(o){F=o,A="@webfonts",O=A+"/"+u;let i=(b,f)=>{d(this,null,function*(){f.setHeader("Content-Type","text/css");try{yield Ae(),f.end(y)}catch(m){p.error(v.default.red(m.message)),f.statusCode=502,f.setHeader("X-Error",m.message.replace(/^Error: /,"")),f.end()}})},c=(b,f)=>{d(this,null,function*(){var R;let m=(R=b.originalUrl)==null?void 0:R.replace(/[?#].*$/,"");f.setHeader("Access-Control-Allow-Origin","*"),f.end(yield Fe(h.get(m)))})};F.middlewares.use($+O,i),F.middlewares.use($+u,i),F.middlewares.use((b,f,m)=>{var ie;let R=(ie=b.originalUrl)==null?void 0:ie.replace(/[?#].*$/,"");if(!R)return m();R.match(/\.(?:woff2?|eot|ttf|otf|svg)$/)&&h.has(R)?c(b,f):m()})},transformIndexHtml(o,i){return k.set(i.path.replace(/^\//,""),o),F&&(s.clear(),Q(o),o=X.removeTags(o),o=re(o)),o},generateBundle(o,i){return d(this,null,function*(){G=this,be(),xe(i);try{let c=yield Z();c&&(ee(c),yield Ce(),te(),(a.injectAsStyleTag===!1||!k.size)&&Re(),k.forEach((b,f)=>{let m=i[f];m!==void 0&&(m.source=X.removeTags(m.source),m.source=re(m.source,y),k.set(f,m.source))}))}catch(c){p.error(v.default.red(c.message)),c instanceof ye.AxiosError&&c.request instanceof we.ClientRequest&&p.error(v.default.red(`${c.request.method} ${c.request.protocol}//${c.request.host}${c.request.path}`))}})}}}0&&(module.exports={ViteWebfontDownload,viteWebfontDl,viteWebfontDownload,webfontDl,webfontDownload});
